# Chapter 23. 실행 컨텍스트

## Index

[23.1 소스코드의 타입](#1)<br>
[23.2 소스코드의 평가와 실행](#2)<br>
[23.3 실행컨텍스트의 역할](#3)<br>
[23.4 실행 컨텍스트 스택](#4)<br>
[23.5 렉시컬 환경](#5)<br>
[23.6 실행 컨텍스트의 생성과 식별자 검색 과정](#6)<br>
[23.7 실행 컨텍스트와 블록 레벨 스코프](#7)<br>

<br>

---

## 23.1 소스코드의 타입<a id="1"></a>

- 소스코드의 타입에 따라 실행 컨텍스트를 생성하는 과정과 관리 내용이 상이함

<br>

| 소스코드의 타입 |                                     설명                                      |
| :-------------: | :---------------------------------------------------------------------------: |
|    전역 코드    |  **전역에 존재하는 소스코드**, 전역에 정의된 함수, 클래스 등의 내부코드 제외  |
|    함수 코드    | **함수 내부의 소스코드**, 함수 내부 중첩된 함수, 클래스 등의 내부 코드는 제외 |
|    eval 코드    |                       **eval 함수로 실행되는 소스코드**                       |
|    모듈 코드    |   **모듈 내부의 소스코드**, 모듈 내부의 함수, 클래스 등의 내부 코드는 제외    |

<br>

**_전역 코드_**

- 전역 변수를 관리하기 위한 **전역 스코프** 생성
- 전역 변수/함수를 전역 객체의 프로퍼티/메서드로 바인딩, 참조하기 위해 **전역 객체와 연결**
- 전역 코드 평가 시 **전역 실행 컨텍스트** 생성

<br>

**_함수 코드_**

- 지역 변수, 매개변수, argument 객체 관리를 위해 **지역 스코프** 생성
- 지역 스코프를 스코프 체인에 연결
- 함수 코드 평가 시 **함수 실행 컨텍스트** 생성

<br>

**_eval 코드_**

- strict mode에서 **독자적인 스코프** 생성
- **eval 실행 컨텍스트** 생성

<br>

**_모듈 코드_**

- 모듈 별 **독자적인 스코프** 생성
- **모듈 실행 컨텍스트** 생성

---

<br>

## 23.2 소스코드의 평가와 실행<a id="2"></a>

- JS 엔진은 소스코드를 소스코드 평가와 실행 2단계로 나누어 처리

<br>

**_소스코드 평가 과정_**

- 실행 컨텍스트 생성
- 선언문만 먼저 실행
  - 식별자를 키로 스코프(렉시컬 환경의 환경 레코드)에 등록

<br>

**_소스코드 실행 과정_**

- 런타임 시작
- 소스코드 실행에 필요한 정보를 스코프에서 검색하여 취득
- 소스코드 실행 결과는 다시 스코프에 등록

---

<br>

## 23.3 실행컨텍스트의 역할<a id="3"></a>

- **실행 컨텍스트**는 소스코드 실행에 필요한 **환경을 제공**하고 코드의 **실행 결과를 실제로 관리**하는 영역
- 식별자를 등록하고 관리하는 **스코프**와 코드 실행 순서 관리를 구현한 내부 매커니즘
- **렉시컬 환경**: 식별자 스코프 관리
- **실행 컨텍스트 스택**: 코드 실행 순서 관리

---

<br>

## 23.4 실행 컨텍스트 스택<a id="4"></a>

- **Stack** 자료구조로 관리됨
- 코드의 **실행 순서**를 관리
- 실행 컨텍스트 스택의 **최상위에 존재**하는 실행 컨텍스트는 언제나 실행 중인 실행 컨텍스트

```js
const x = 1;
function foo() {
  const y = 2;

  function bar() {
    const z = 3;
    console.log(x + y + z);
  }
  bar();
}
foo();
```

**_실행 과정_**

1. **전역 코드의 평가, 실행**
   <br>전역 코드를 평가하여 전역 실행 컨텍스트 생성 및 실행 컨텍스트에 푸시
   <br>전역 변수/함수(x / foo)는 전역 실행 컨텍스트에 등록
   <br>전역 코드를 실행하여 전역 변수에 값이 할당되고 전역 함수 호출

2. **foo 함수 코드의 평가와 실행**
   <br>foo 함수 호출 시 전역 코드는 일시 중단되고 코드의 제어권이 foo 함수 내부로 이동
   <br>foo 함수 내부 코드 평가하여 foo 함수 실행 컨텍스트 생성하고 실행 컨텍스트 스택에 푸시
   <br>foo 함수 지역 변수, 중첩 함수(y / bar)를 foo 함수 실행 컨텍스트에 등록
   <br>foo 함수 코드 실행하여 y 값 할당 및 bar 호출

3. **bar 함수 코드의 평가와 실행**
   <br>foo 함수 실행 일시 중지 및 bar 함수에 코드 제어권 넘어감
   <br>bar 함수 평가하여 bar 함수 실행 컨텍스트 생성 및 실행 컨텍스트 스택에 푸시
   <br>z가 bar 함수 컨텍스트에 등록
   <br>bar 함수 실행하여 z값 할당 및 console.log 메서드 호출
   <br>bar 함수 종료

4. **foo 함수로 복귀**
   <br>bar 함수 실행 컨텍스트를 실행 컨텍스트 스택에서 팝
   <br>코드 제어권 foo에게 넘어가고 foo 코드가 끝나서 종료

5. **전역 코드로 복귀**
   <br>코드 제어권 전역 코드로 넘어가며 foo 실행 컨텍스트를 스택에서 팝
   <br>전역 코드도 실행할 코드 없어서 종료
   <br>전역 실행 컨텍스트를 실행 컨텍스트 스택에서 팝

---

<br>

## 23.5 렉시컬 환경<a id="5"></a>

- `식별자`, `식별자에 바인딩된 값`, `상위 스코프에 대한 참조`를 기록하는 자료구조
- 실행 컨텍스트를 구성하는 컴포넌트
- **스코프와 식별자** 관리
  - 스코프를 구분하여 식별자를 등록하고 관리하는 저장소 역할
  - 렉시컬 스코프의 실체

<br>

- **렉시컬 환경의 구성**
  - 환경 레코드 (Environment Record)
    - 스코프에 포함된 식별자 등록 및 바인딩 값 관리
  - 외부 렉시컬 환경에 대한 참조 (OuterLexicalEnvironmentReference)
    - 상위 스코프를 가리킴
    - 단방향 링크드 리스트인 _스코프 체인 구현_
- `LexicalEnvironment` 컴포넌트와 `VariableEnvironment` 컴포넌트 등은 구분하지 않고 간략하게 설명

---

<br>

## 23.6 실행 컨텍스트의 생성과 식별자 검색 과정<a id="6"></a>

**_전역 코드 평가_**

- 전역 실행 컨텍스트 생성
- 전역 렉시컬 환경 생성
  - 전역 환경 레코드 생성
    - 객체 환경 레코드 생성
    - 선언적 환경 레코드 생성
  - this 바인딩
  - 외부 렉시컬에 대한 참조 결정

<br>

**_함수 코드 평가_**

- 함수 실행 컨텍스트 생성
- 함수 렉시컬 환경 생성
  - 함수 환경 레코드 생성
  - this 바인딩
  - 외부 렉시컬 환경에 대한 참조 결정

```js
var x = 1;
const y = 2;

function foo(a) {
  var x = 3;
  const y = 4;

  function bar(b) {
    const z = 5;
    console.log(a + b + x + y + z);
  }
  bar(10);
}
foo(20); // 42
```

![전역](https://user-images.githubusercontent.com/60606025/149098744-15eb77cd-c9e2-4180-8a1f-9f6f67ae7baa.jpg)

- 세부과정은 책 참조

---

<br>

## 23.7 실행 컨텍스트와 블록 레벨 스코프<a id="7"></a>

- 함수레벨 스코프가 아닌 **블록 레벨 스코프**는 렉시컬 환경 새롭게 생성
- 반복문은 반복마다 새로운 렉시컬 환경 생성

```js
let x = 1;

if (true) {
  let x = 10;
  console.log(x); // 10
}

console.log(x); // 1
```

![블록](https://user-images.githubusercontent.com/60606025/149098852-78f4d8e9-dc76-470a-9591-35f5d38c998c.jpg)
